name: Telegram Bot Runner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install pyTelegramBotAPI
    
    - name: Create bot script
      run: |
        cat > cloud_bot.py << 'EOF'
import os
import telebot
from telebot import types
import json
import datetime

# Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
BOT_TOKEN = os.environ.get('BOT_TOKEN')

if not BOT_TOKEN:
    print("âŒ BOT_TOKEN not found!")
    exit(1)

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
bot = telebot.TeleBot(BOT_TOKEN)

# Ð¤Ð°Ð¹Ð» Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
DATA_FILE = "bot_data.json"

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
def load_data():
    try:
        if os.path.exists(DATA_FILE):
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        else:
            return {"weeks": {"week_1": create_new_week()}, "current_week": "week_1"}
    except Exception as e:
        print(f"Error loading data: {e}")
        return {"weeks": {"week_1": create_new_week()}, "current_week": "week_1"}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð½ÐµÐ´ÐµÐ»Ð¸
def create_new_week():
    initial_names = ["ÐÐ»ÐµÐºÑÐµÐ¹", "ÐœÐ°Ñ€Ð¸Ñ", "Ð˜Ð²Ð°Ð½", "ÐÐ½Ð½Ð°", "Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸Ð¹"]
    return {
        "names": initial_names,
        "scores": {name: ["âŒ", "âŒ", "âŒ", "âŒ", "âŒ"] for name in initial_names},
        "lives": {name: 3 for name in initial_names},
        "bonus_points": {name: 0 for name in initial_names},
        "created_date": datetime.datetime.now().strftime("%d.%m.%Y %H:%M")
    }

# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð°
@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    btn1 = types.KeyboardButton("ðŸ“Š ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÐ¸")
    btn2 = types.KeyboardButton("ðŸ‘¥ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð²")
    btn3 = types.KeyboardButton("âœ… Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÐ¸")
    btn4 = types.KeyboardButton("ðŸ’” Ð¡Ð½ÑÑ‚ÑŒ Ð¶Ð¸Ð·Ð½ÑŒ")
    btn5 = types.KeyboardButton("âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð»Ñ‹")
    btn6 = types.KeyboardButton("ðŸ“… Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½ÐµÐ´ÐµÐ»ÑÐ¼Ð¸")
    btn7 = types.KeyboardButton("â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ")
    markup.add(btn1, btn2, btn3, btn4, btn5, btn6, btn7)
    
    welcome_text = "ðŸ‘‹ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² Ð¾Ð±Ð»Ð°ÐºÐµ! Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ."
    bot.send_message(message.chat.id, welcome_text, reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == "ðŸ“Š ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÐ¸")
def show_scores(message):
    data = load_data()
    week_data = data["weeks"][data["current_week"]]
    
    message_text = f"ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¾Ñ†ÐµÐ½ÐºÐ¸ (ÐÐµÐ´ÐµÐ»Ñ {data['current_week'].replace('week_', '')}):\n\n"
    
    for name in week_data["names"]:
        scores = week_data["scores"].get(name, ["âŒ", "âŒ", "âŒ", "âŒ", "âŒ"])
        lives = week_data["lives"].get(name, 3)
        score_display = " ".join(scores)
        total_score = scores.count("âœ…") * 10 - (3 - lives) * 50
        
        message_text += f"{name}: {score_display} - {total_score} Ð¾Ñ‡ÐºÐ¾Ð² (â¤ï¸{lives}/3)\n"
    
    bot.send_message(message.chat.id, message_text)

@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    if message.text == "â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ":
        help_text = """ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
ðŸ“Š ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÐ¸
ðŸ‘¥ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð²  
âœ… Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¾Ñ†ÐµÐ½ÐºÐ¸
ðŸ’” Ð¡Ð½ÑÑ‚ÑŒ Ð¶Ð¸Ð·Ð½ÑŒ
âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð»Ñ‹
ðŸ“… Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½ÐµÐ´ÐµÐ»ÑÐ¼Ð¸"""
        bot.send_message(message.chat.id, help_text)
    else:
        bot.send_message(message.chat.id, "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð±Ð¾Ñ‚Ð¾Ð¼")

# Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
if __name__ == "__main__":
    print("ðŸš€ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð² Ð¾Ð±Ð»Ð°ÐºÐµ...")
    print(f"ðŸ¤– Ð¢Ð¾ÐºÐµÐ½: {BOT_TOKEN[:10]}...")
    try:
        bot.polling(none_stop=True, timeout=60)
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
EOF

    - name: Run Telegram Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        echo "Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
        python cloud_bot.py
